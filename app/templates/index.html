<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Statement Extraction Platform</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â• RESET & BASE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg-base: #020617; --bg-card: rgba(15,23,42,0.5); --bg-hover: rgba(30,41,59,0.3);
  --border: rgba(30,41,59,0.8); --border-hover: rgba(51,65,85,0.8);
  --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b; --text-white: #ffffff;
  --cyan: #22d3ee; --cyan-dim: rgba(6,182,212,0.1); --cyan-border: rgba(6,182,212,0.3);
  --emerald: #34d399; --emerald-dim: rgba(16,185,129,0.1); --emerald-border: rgba(16,185,129,0.3);
  --amber: #fbbf24; --amber-dim: rgba(245,158,11,0.1); --amber-border: rgba(245,158,11,0.3);
  --red: #f87171; --red-dim: rgba(239,68,68,0.1); --red-border: rgba(239,68,68,0.3);
  --purple: #c084fc; --purple-dim: rgba(168,85,247,0.1); --purple-border: rgba(168,85,247,0.3);
  --blue: #60a5fa; --blue-dim: rgba(59,130,246,0.1); --blue-border: rgba(59,130,246,0.3);
  --slate: #94a3b8; --slate-dim: rgba(100,116,139,0.1); --slate-border: rgba(100,116,139,0.3);
}
body { background: var(--bg-base); color: var(--text-primary); font-family: 'DM Sans', system-ui, sans-serif; line-height: 1.5; }
a { color: var(--cyan); text-decoration: none; }
a:hover { color: #67e8f9; }
code, .mono { font-family: 'JetBrains Mono', monospace; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: #0f172a; }
::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

/* â•â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }
.header { border-bottom: 1px solid var(--border); background: rgba(2,6,23,0.9); backdrop-filter: blur(16px); position: sticky; top: 0; z-index: 40; }
.header-inner { display: flex; align-items: center; justify-content: space-between; height: 64px; }
.logo { display: flex; align-items: center; gap: 10px; }
.logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--cyan), #2563eb); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 13px; }
.logo-text-main { font-size: 14px; font-weight: 700; color: var(--text-white); letter-spacing: -0.3px; }
.logo-text-sub { font-size: 10px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
.nav { display: flex; gap: 4px; }
.nav-btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500; border: none; cursor: pointer; background: transparent; color: var(--text-muted); transition: all 0.15s; }
.nav-btn:hover { color: var(--text-white); background: var(--bg-hover); }
.nav-btn.active { color: var(--text-white); background: rgba(30,41,59,1); }
.nav-badge { margin-left: 6px; padding: 1px 6px; font-size: 10px; font-weight: 700; border-radius: 9999px; background: var(--amber-dim); color: var(--amber); }
.upload-btn { padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; background: var(--cyan); color: white; transition: all 0.15s; display: flex; align-items: center; gap: 6px; }
.upload-btn:hover { background: #06b6d4; }
.main { padding: 32px 0; }

/* â•â•â• METRICS GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
@media (max-width: 768px) { .metrics { grid-template-columns: repeat(2, 1fr); } }
.metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; transition: border-color 0.15s; }
.metric-card:hover { border-color: var(--border-hover); }
.metric-label { font-size: 11px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.metric-value { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; color: var(--text-white); }
.metric-value.cyan { color: var(--cyan); }
.metric-value.emerald { color: var(--emerald); }
.metric-value.amber { color: var(--amber); }
.metric-value.red { color: var(--red); }
.metric-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

/* â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
.panel-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.panel-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.panel-link { font-size: 12px; color: var(--cyan); font-weight: 500; cursor: pointer; }
.panel-link:hover { color: #67e8f9; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 10px 24px; font-size: 10px; font-weight: 500; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
td { padding: 14px 24px; font-size: 13px; }
tbody tr { border-top: 1px solid rgba(30,41,59,0.4); cursor: pointer; transition: background 0.1s; }
tbody tr:hover { background: var(--bg-hover); }
.doc-name { color: var(--text-white); font-weight: 500; }
.doc-id { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-family: 'JetBrains Mono', monospace; }
.doc-date { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

/* â•â•â• STATUS BADGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 9999px; font-size: 11px; font-weight: 500; }
.badge-dot { width: 6px; height: 6px; border-radius: 50%; }
.badge-COMPLETED { background: var(--emerald-dim); color: var(--emerald); border: 1px solid var(--emerald-border); }
.badge-COMPLETED .badge-dot { background: var(--emerald); }
.badge-NEEDS_REVIEW { background: var(--amber-dim); color: var(--amber); border: 1px solid var(--amber-border); }
.badge-NEEDS_REVIEW .badge-dot { background: var(--amber); }
.badge-EXTRACTING, .badge-RENDERING, .badge-PREPROCESSING, .badge-VALIDATING, .badge-SEGMENTING {
  background: var(--cyan-dim); color: var(--cyan); border: 1px solid var(--cyan-border); }
.badge-EXTRACTING .badge-dot, .badge-RENDERING .badge-dot, .badge-PREPROCESSING .badge-dot,
.badge-VALIDATING .badge-dot, .badge-SEGMENTING .badge-dot { background: var(--cyan); animation: pulse 1.5s ease-in-out infinite; }
.badge-QUEUED, .badge-UPLOADED { background: var(--slate-dim); color: var(--slate); border: 1px solid var(--slate-border); }
.badge-QUEUED .badge-dot, .badge-UPLOADED .badge-dot { background: var(--slate); }
.badge-FAILED { background: var(--red-dim); color: var(--red); border: 1px solid var(--red-border); }
.badge-FAILED .badge-dot { background: var(--red); }

/* â•â•â• CONFIDENCE METER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.conf-wrap { display: flex; align-items: center; gap: 10px; }
.conf-bar { width: 64px; height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; }
.conf-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }
.conf-fill.high { background: var(--emerald); }
.conf-fill.mid { background: var(--cyan); }
.conf-fill.low { background: var(--amber); }
.conf-fill.bad { background: var(--red); }
.conf-text { font-size: 12px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
.conf-text.high { color: var(--emerald); }
.conf-text.mid { color: var(--cyan); }
.conf-text.low { color: var(--amber); }
.conf-text.bad { color: var(--red); }

/* â•â•â• TYPE BADGE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.type-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; }
.type-BANK_STATEMENT { background: var(--blue-dim); color: var(--blue); }
.type-MOTOR_FINANCE { background: var(--purple-dim); color: var(--purple); }
.type-UNKNOWN { background: var(--slate-dim); color: var(--slate); }

/* â•â•â• FILTERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filters { display: flex; gap: 8px; flex-wrap: wrap; }
.filter-btn { padding: 6px 12px; font-size: 11px; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; background: var(--bg-card); color: var(--text-muted); border: 1px solid var(--border); transition: all 0.15s; }
.filter-btn:hover, .filter-btn.active { color: var(--text-white); background: rgba(30,41,59,0.8); border-color: var(--border-hover); }

/* â•â•â• REVIEW ITEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.review-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 12px; transition: border-color 0.15s; }
.review-item:hover { border-color: var(--border-hover); }
.review-top { display: flex; justify-content: space-between; align-items: flex-start; }
.review-reason { font-size: 11px; font-family: 'JetBrains Mono', monospace; padding: 2px 8px; border-radius: 4px; background: var(--red-dim); color: var(--red); border: 1px solid var(--red-border); }
.review-time { font-size: 11px; color: var(--text-muted); }
.review-actions { display: flex; align-items: center; gap: 8px; }
.priority-badge { font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 4px; }
.priority-1 { background: var(--red-dim); color: var(--red); }
.priority-2 { background: var(--amber-dim); color: var(--amber); }
.priority-3 { background: var(--slate-dim); color: var(--slate); }
.review-btn { padding: 6px 12px; font-size: 11px; font-weight: 500; border-radius: 8px; border: 1px solid var(--cyan-border); background: var(--cyan-dim); color: var(--cyan); cursor: pointer; transition: all 0.15s; }
.review-btn:hover { background: rgba(6,182,212,0.2); }

/* â•â•â• DETAIL VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.back-link { font-size: 13px; color: var(--cyan); cursor: pointer; margin-bottom: 16px; display: inline-block; }
.back-link:hover { color: #67e8f9; }
.detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
.detail-title { font-size: 20px; font-weight: 700; color: var(--text-white); }
.detail-metrics { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; margin-bottom: 24px; }
@media (max-width: 768px) { .detail-metrics { grid-template-columns: repeat(2, 1fr); } }
.tx-table th:last-child, .tx-table td:last-child { text-align: right; }
.empty-state { text-align: center; padding: 48px; color: var(--text-muted); }
.empty-state code { display: inline-block; margin-top: 8px; padding: 6px 12px; background: #1e293b; border-radius: 6px; font-size: 12px; color: var(--cyan); }

/* â•â•â• UPLOAD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 50; display: flex; align-items: center; justify-content: center; }
.modal { background: #0f172a; border: 1px solid #334155; border-radius: 16px; padding: 32px; width: 100%; max-width: 480px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
.modal-title { font-size: 18px; font-weight: 700; color: var(--text-white); }
.modal-close { font-size: 24px; color: var(--text-muted); cursor: pointer; border: none; background: none; line-height: 1; }
.modal-close:hover { color: var(--text-white); }
.drop-zone { border: 2px dashed #334155; border-radius: 12px; padding: 48px; text-align: center; cursor: pointer; transition: all 0.15s; margin: 24px 0; }
.drop-zone:hover, .drop-zone.dragging { border-color: var(--cyan); background: rgba(6,182,212,0.03); }
.drop-zone.has-file { border-color: var(--emerald-border); background: rgba(16,185,129,0.03); }
.drop-icon { font-size: 36px; margin-bottom: 12px; color: var(--text-muted); }
.modal-buttons { display: flex; gap: 12px; }
.modal-buttons button { flex: 1; padding: 12px; font-size: 14px; font-weight: 600; border-radius: 12px; border: none; cursor: pointer; transition: all 0.15s; }
.btn-cancel { background: #1e293b; color: var(--text-secondary); }
.btn-cancel:hover { background: #334155; }
.btn-submit { background: var(--cyan); color: white; }
.btn-submit:hover { background: #06b6d4; }
.btn-submit:disabled { opacity: 0.3; cursor: not-allowed; }

/* â•â•â• ANIMATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.3s ease-out; }

/* â•â•â• CONNECTION INDICATOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.conn-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
.conn-dot.connected { background: var(--emerald); }
.conn-dot.disconnected { background: var(--red); animation: pulse 1.5s ease-in-out infinite; }
.conn-label { font-size: 11px; color: var(--text-muted); }
</style>
</head>
<body>

<div id="app"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  view: 'overview',        // overview | documents | review
  documents: [],
  selectedDoc: null,
  transactions: [],
  reviewQueue: [],
  stats: { total: 0, today: 0, review: 0, avgConf: 0, reconRate: 0, totalTx: 0, avgTime: 0, queue: 0 },
  filter: 'ALL',
  apiConnected: false,
  showUpload: false,
  uploadFile: null,
  uploading: false,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function api(path) {
  try {
    const r = await fetch(path);
    if (!r.ok) throw new Error(r.statusText);
    return await r.json();
  } catch (e) {
    console.warn(`API ${path}:`, e.message);
    return null;
  }
}

async function refreshData() {
  const health = await api('/health');
  state.apiConnected = health && health.status !== undefined;

  const resp = await api('/api/v1/documents');
  if (resp && resp.documents && Array.isArray(resp.documents)) {
    state.documents = resp.documents;
    const docs = resp.documents;
    // Compute stats from real data
    state.stats.total = resp.total || docs.length;
    state.stats.today = docs.filter(d => {
      const dt = new Date(d.created_at);
      const now = new Date();
      return dt.toDateString() === now.toDateString();
    }).length;
    state.stats.review = docs.filter(d => d.status === 'NEEDS_REVIEW').length;
    state.stats.avgConf = 0;
    state.stats.queue = docs.filter(d => ['QUEUED', 'RENDERING', 'PREPROCESSING', 'EXTRACTING', 'SEGMENTING', 'VALIDATING'].includes(d.status)).length;
  }

  render();
}

async function uploadFile() {
  if (!state.uploadFile) return;
  state.uploading = true;
  render();

  const fd = new FormData();
  fd.append('file', state.uploadFile);

  try {
    const r = await fetch('/api/v1/documents', { method: 'POST', body: fd });
    if (r.ok) {
      state.showUpload = false;
      state.uploadFile = null;
      state.uploading = false;
      await refreshData();
      return;
    } else {
      const err = await r.text();
      console.error('Upload error:', r.status, err);
      alert('Upload failed: ' + r.status);
    }
  } catch (e) {
    console.error('Upload failed:', e);
    alert('Upload failed: ' + e.message);
  }
  state.uploading = false;
  render();
}

async function loadTransactions(docId) {
  const txns = await api(`/api/v1/documents/${docId}/transactions`);
  state.transactions = (txns && Array.isArray(txns)) ? txns : [];
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDate(iso) {
  if (!iso) return '--';
  return new Date(iso).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
}
function fmtTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}
function fmtPct(v) { return v != null ? (v * 100).toFixed(1) + '%' : '--'; }
function confClass(v) { return v >= 0.9 ? 'high' : v >= 0.75 ? 'mid' : v >= 0.6 ? 'low' : 'bad'; }
function fmtMoney(v) { return v != null ? 'Â£' + Math.abs(v).toFixed(2) : '--'; }

function h(tag, attrs, ...children) {
  const el = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k, v]) => {
    if (k === 'className') el.className = v;
    else if (k.startsWith('on')) el.addEventListener(k.slice(2).toLowerCase(), v);
    else if (k === 'style' && typeof v === 'object') Object.assign(el.style, v);
    else if (k === 'innerHTML') el.innerHTML = v;
    else if (typeof v === 'boolean') { if (v) el.setAttribute(k, ''); else el.removeAttribute(k); }
    else el.setAttribute(k, v);
  });
  children.flat(Infinity).forEach(c => {
    if (c == null || c === false) return;
    el.appendChild(typeof c === 'string' || typeof c === 'number' ? document.createTextNode(c) : c);
  });
  return el;
}

function badge(status) {
  return h('span', { className: `badge badge-${status}` },
    h('span', { className: 'badge-dot' }),
    status.replace(/_/g, ' ')
  );
}

function confMeter(value) {
  if (value == null) return h('span', { style: { color: 'var(--text-muted)', fontSize: '13px' } }, '--');
  const pct = Math.round(value * 100);
  const cls = confClass(value);
  return h('div', { className: 'conf-wrap' },
    h('div', { className: 'conf-bar' },
      h('div', { className: `conf-fill ${cls}`, style: { width: pct + '%' } })
    ),
    h('span', { className: `conf-text ${cls}` }, pct + '%')
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHeader() {
  return h('header', { className: 'header' },
    h('div', { className: 'container header-inner' },
      h('div', { className: 'logo' },
        h('div', { className: 'logo-icon' }, 'SE'),
        h('div', null,
          h('div', { className: 'logo-text-main' }, 'Statement Extraction'),
          h('div', { className: 'logo-text-sub' }, 'Platform v{{ version }}')
        ),
        h('div', { style: { marginLeft: '16px', display: 'flex', alignItems: 'center' } },
          h('span', { className: `conn-dot ${state.apiConnected ? 'connected' : 'disconnected'}` }),
          h('span', { className: 'conn-label' }, state.apiConnected ? 'API Connected' : 'Connecting...')
        )
      ),
      h('nav', { className: 'nav' },
        ...['overview', 'documents', 'review'].map(v =>
          h('button', {
            className: `nav-btn ${state.view === v ? 'active' : ''}`,
            onClick: () => { state.view = v; state.selectedDoc = null; render(); }
          },
            v.charAt(0).toUpperCase() + v.slice(1),
            v === 'review' && state.stats.review > 0 ? h('span', { className: 'nav-badge' }, String(state.stats.review)) : null
          )
        )
      ),
      h('button', { className: 'upload-btn', onClick: () => { state.showUpload = true; render(); } }, '+ Upload')
    )
  );
}

function renderOverview() {
  const s = state.stats;
  return h('div', { className: 'fade-in' },
    h('div', { className: 'metrics' },
      metricCard('Total Documents', String(s.total), 'All time'),
      metricCard('Processed Today', String(s.today), `${s.queue} in queue`, 'cyan'),
      metricCard('Avg Confidence', fmtPct(s.avgConf), 'Document level', s.avgConf >= 0.85 ? 'emerald' : 'amber'),
      metricCard('Needs Review', String(s.review), 'Pending items', s.review > 0 ? 'amber' : 'emerald')
    ),
    renderDocTable(state.documents.slice(0, 8), true)
  );
}

function metricCard(label, value, sub, accent) {
  return h('div', { className: 'metric-card' },
    h('div', { className: 'metric-label' }, label),
    h('div', { className: `metric-value ${accent || ''}` }, value),
    sub ? h('div', { className: 'metric-sub' }, sub) : null
  );
}

function renderDocTable(docs, showLink) {
  return h('div', { className: 'panel' },
    h('div', { className: 'panel-header' },
      h('div', { className: 'panel-title' }, showLink ? 'Recent Documents' : `Documents (${state.filter === 'ALL' ? docs.length : state.filter})`),
      showLink ? h('span', { className: 'panel-link', onClick: () => { state.view = 'documents'; render(); } }, 'View All â†’') : null
    ),
    !showLink ? h('div', { style: { padding: '12px 24px', borderBottom: '1px solid var(--border)' } },
      h('div', { className: 'filters' },
        ...['ALL', 'COMPLETED', 'NEEDS_REVIEW', 'EXTRACTING', 'QUEUED', 'FAILED'].map(f =>
          h('button', {
            className: `filter-btn ${state.filter === f ? 'active' : ''}`,
            onClick: () => { state.filter = f; render(); }
          }, f.replace(/_/g, ' '))
        )
      )
    ) : null,
    h('table', null,
      h('thead', null,
        h('tr', null,
          h('th', null, 'Document'),
          h('th', null, 'Type'),
          h('th', null, 'Provider'),
          h('th', null, 'Pages'),
          h('th', null, 'Status'),
          h('th', null, 'Confidence'),
          h('th', { style: { textAlign: 'right' } }, 'Txns')
        )
      ),
      h('tbody', null,
        ...docs.map(doc =>
          h('tr', {
            onClick: () => {
              state.selectedDoc = doc;
              state.transactions = [];
              state.view = 'documents';
              render();
              if (doc.status === 'COMPLETED') loadTransactions(doc.doc_id);
            }
          },
            h('td', null,
              h('div', { className: 'doc-name' }, doc.file_name),
              h('div', { className: 'doc-date' }, fmtDate(doc.created_at) + ' ' + fmtTime(doc.created_at))
            ),
            h('td', null,
              h('span', { className: `type-badge type-${doc.doc_family || 'UNKNOWN'}` },
                (doc.doc_family || 'UNKNOWN').replace(/_/g, ' '))
            ),
            h('td', { style: { color: 'var(--text-secondary)', fontSize: '13px' } }, doc.provider_guess || '--'),
            h('td', { className: 'mono', style: { color: 'var(--text-muted)', fontSize: '13px' } }, doc.page_count != null ? String(doc.page_count) : '--'),
            h('td', null, badge(doc.status)),
            h('td', null, confMeter(doc.confidence_document)),
            h('td', { className: 'mono', style: { textAlign: 'right', color: 'var(--text-secondary)', fontSize: '13px' } }, doc.transaction_count != null ? String(doc.transaction_count) : '--')
          )
        ),
        docs.length === 0 ? h('tr', null, h('td', { colspan: '7', style: { textAlign: 'center', padding: '48px', color: 'var(--text-muted)' } }, 'No documents found')) : null
      )
    )
  );
}

function renderDocuments() {
  if (state.selectedDoc) return renderDetail();
  const filtered = state.filter === 'ALL' ? state.documents : state.documents.filter(d => d.status === state.filter);
  return h('div', { className: 'fade-in' },
    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
      h('h2', { style: { fontSize: '20px', fontWeight: 700, color: 'var(--text-white)' } }, 'Documents')
    ),
    renderDocTable(filtered, false)
  );
}

function renderDetail() {
  const d = state.selectedDoc;
  return h('div', { className: 'fade-in' },
    h('span', { className: 'back-link', onClick: () => { state.selectedDoc = null; render(); } }, 'â† Back to Documents'),
    h('div', { className: 'detail-header' },
      h('div', null,
        h('div', { className: 'detail-title' }, d.file_name),
        h('div', { className: 'doc-id' }, d.doc_id)
      ),
      badge(d.status)
    ),
    h('div', { className: 'detail-metrics' },
      metricCard('Provider', d.provider_guess || 'Unknown'),
      metricCard('Doc Type', (d.doc_family || 'UNKNOWN').replace(/_/g, ' ')),
      metricCard('Pages', d.page_count != null ? String(d.page_count) : '--'),
      metricCard('Confidence', fmtPct(d.confidence_document), null, d.confidence_document >= 0.85 ? 'emerald' : 'amber'),
      metricCard('Transactions', d.transaction_count != null ? String(d.transaction_count) : '0', null, 'cyan')
    ),
    h('div', { className: 'panel' },
      h('div', { className: 'panel-header' },
        h('div', { className: 'panel-title' }, 'Extracted Transactions')
      ),
      state.transactions.length > 0
        ? h('table', { className: 'tx-table' },
            h('thead', null,
              h('tr', null,
                h('th', null, 'Date'),
                h('th', null, 'Description'),
                h('th', null, 'Direction'),
                h('th', null, 'Balance'),
                h('th', { style: { textAlign: 'right' } }, 'Amount')
              )
            ),
            h('tbody', null,
              ...state.transactions.map(tx =>
                h('tr', null,
                  h('td', { style: { fontSize: '12px', color: 'var(--text-secondary)' } }, fmtDate(tx.posted_date)),
                  h('td', { style: { fontSize: '13px', color: 'var(--text-white)', maxWidth: '300px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, tx.description_clean || tx.description_raw || '--'),
                  h('td', null,
                    h('span', {
                      className: `type-badge`,
                      style: {
                        background: tx.direction === 'DEBIT' ? 'var(--red-dim)' : tx.direction === 'CREDIT' ? 'var(--emerald-dim)' : 'var(--slate-dim)',
                        color: tx.direction === 'DEBIT' ? 'var(--red)' : tx.direction === 'CREDIT' ? 'var(--emerald)' : 'var(--slate)'
                      }
                    }, tx.direction)
                  ),
                  h('td', { className: 'mono', style: { fontSize: '12px', color: 'var(--text-muted)' } }, tx.running_balance != null ? fmtMoney(tx.running_balance) : '--'),
                  h('td', {
                    className: 'mono',
                    style: {
                      textAlign: 'right', fontSize: '13px', fontWeight: 600,
                      color: tx.direction === 'DEBIT' ? 'var(--red)' : tx.direction === 'CREDIT' ? 'var(--emerald)' : 'var(--text-secondary)'
                    }
                  }, tx.direction === 'DEBIT' ? '-' + fmtMoney(tx.amount) : fmtMoney(tx.amount))
                )
              )
            )
          )
        : h('div', { className: 'empty-state' },
            d.status === 'COMPLETED'
              ? [h('div', null, 'No transactions loaded'),
                 h('code', null, `GET /api/v1/documents/${d.doc_id}/transactions`)]
              : d.status === 'FAILED'
                ? h('div', null, 'Extraction failed. Check logs.')
                : ['EXTRACTING', 'RENDERING', 'PREPROCESSING', 'SEGMENTING', 'VALIDATING'].includes(d.status)
                  ? h('div', null, 'Processing in progress...')
                  : h('div', null, 'Waiting in queue...')
          )
    )
  );
}

function renderReview() {
  const reviewDocs = state.documents.filter(d => d.status === 'NEEDS_REVIEW');
  return h('div', { className: 'fade-in' },
    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' } },
      h('h2', { style: { fontSize: '20px', fontWeight: 700, color: 'var(--text-white)' } }, 'Review Queue'),
      h('span', { style: { fontSize: '13px', color: 'var(--text-muted)' } }, `${reviewDocs.length} pending`)
    ),
    ...reviewDocs.map(doc =>
      h('div', { className: 'review-item' },
        h('div', { className: 'review-top' },
          h('div', null,
            h('div', { style: { color: 'var(--text-white)', fontWeight: 500 } }, doc.file_name),
            h('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginTop: '8px' } },
              h('span', { className: 'review-reason' }, 'LOW_CONFIDENCE'),
              h('span', { className: 'review-time' }, fmtDate(doc.created_at))
            )
          ),
          h('div', { className: 'review-actions' },
            h('button', {
              className: 'review-btn',
              onClick: () => { state.selectedDoc = doc; state.view = 'documents'; render(); }
            }, 'Review')
          )
        )
      )
    ),
    reviewDocs.length === 0 ? h('div', { className: 'empty-state' },
      h('div', { style: { fontSize: '36px', marginBottom: '16px' } }, 'âœ“'),
      h('div', { style: { fontSize: '16px', fontWeight: 500, color: 'var(--text-secondary)' } }, 'All clear'),
      h('div', null, 'No items pending review')
    ) : null
  );
}

function renderUploadModal() {
  if (!state.showUpload) return null;
  const overlay = h('div', { className: 'modal-overlay', onClick: () => { state.showUpload = false; render(); } },
    h('div', { className: 'modal', onClick: (e) => e.stopPropagation() },
      h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' } },
        h('h2', { className: 'modal-title' }, 'Upload Statement'),
        h('button', { className: 'modal-close', onClick: () => { state.showUpload = false; state.uploadFile = null; render(); } }, 'Ã—')
      ),
      h('div', {
        className: `drop-zone ${state.uploadFile ? 'has-file' : ''}`,
        onClick: () => document.getElementById('file-input').click(),
        onDragover: (e) => { e.preventDefault(); e.currentTarget.classList.add('dragging'); },
        onDragleave: (e) => { e.currentTarget.classList.remove('dragging'); },
        onDrop: (e) => {
          e.preventDefault();
          e.currentTarget.classList.remove('dragging');
          const f = e.dataTransfer.files[0];
          if (f && f.type === 'application/pdf') { state.uploadFile = f; render(); }
        }
      },
        state.uploadFile
          ? [h('div', { style: { fontSize: '32px', marginBottom: '12px' } }, 'ğŸ“„'),
             h('div', { style: { color: 'var(--text-white)', fontWeight: 500 } }, state.uploadFile.name),
             h('div', { style: { color: 'var(--text-muted)', fontSize: '13px', marginTop: '4px' } }, (state.uploadFile.size / 1024 / 1024).toFixed(2) + ' MB')]
          : [h('div', { className: 'drop-icon' }, 'â†‘'),
             h('div', { style: { color: 'var(--text-secondary)' } }, 'Drop PDF here or click to browse'),
             h('div', { style: { color: 'var(--text-muted)', fontSize: '13px', marginTop: '8px' } }, 'Maximum 50MB')]
      ),
      h('input', { type: 'file', id: 'file-input', accept: '.pdf', style: { display: 'none' },
        onChange: (e) => { if (e.target.files[0]) { state.uploadFile = e.target.files[0]; render(); } }
      }),
      h('div', { className: 'modal-buttons' },
        h('button', { className: 'btn-cancel', onClick: () => { state.showUpload = false; state.uploadFile = null; render(); } }, 'Cancel'),
        h('button', {
          className: 'btn-submit',
          disabled: !state.uploadFile || state.uploading,
          onClick: uploadFile
        }, state.uploading ? 'Uploading...' : 'Process Statement')
      )
    )
  );
  return overlay;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
  const app = document.getElementById('app');
  app.innerHTML = '';
  app.appendChild(renderHeader());

  const main = h('main', { className: 'main' }, h('div', { className: 'container' },
    state.view === 'overview' ? renderOverview() :
    state.view === 'documents' ? renderDocuments() :
    renderReview()
  ));
  app.appendChild(main);

  const modal = renderUploadModal();
  if (modal) app.appendChild(modal);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
render();
refreshData();
setInterval(refreshData, POLL_INTERVAL);
</script>
</body>
</html>